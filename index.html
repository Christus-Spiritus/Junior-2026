<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Christus Junior</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(17,26,46,.88);
      --text:#e8eefc;
      --muted:#a7b4d6;
      --accent:#7aa2ff;
      --ok:#4ade80;
      --warn:#fbbf24;
      --bad:#fb7185;
      --line:rgba(255,255,255,.10);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% -10%, rgba(122,162,255,.25), transparent 60%),
        radial-gradient(900px 500px at 95% 0%, rgba(74,222,128,.16), transparent 55%),
        linear-gradient(180deg,#070b14,var(--bg));
    }
    .wrap{ max-width:1040px; margin:0 auto; padding:16px; }
    .appbar{
      position:sticky; top:0; z-index:5;
      padding:12px 0 10px;
      background:linear-gradient(180deg, rgba(11,18,32,.98), rgba(11,18,32,.65) 70%, transparent);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .logo{
      display:flex; gap:10px; align-items:center;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted);
      background:rgba(255,255,255,.06);
      font-size:12px;
    }
    .title{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .subtitle{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
    }
    .btn{
      background:rgba(122,162,255,.14);
      color:var(--text);
      border:1px solid rgba(122,162,255,.35);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight:650;
      user-select:none;
      transition: transform .05s ease;
    }
    .btn:active{ transform:translateY(1px); }
    .btn.secondary{ background:rgba(255,255,255,.08); border:1px solid var(--line); font-weight:600; }
    .btn.warn{ background:rgba(251,191,36,.10); border:1px solid rgba(251,191,36,.35); }
    .btn.bad{ background:rgba(251,113,133,.10); border:1px solid rgba(251,113,133,.35); }
    .btn[aria-disabled="true"]{ opacity:.45; pointer-events:none; }

    .grid{ display:grid; gap:12px; }
    @media (min-width: 920px){ .grid{ grid-template-columns:1.15fr .85fr; } }

    .card{
      background:var(--card);
      border:1px solid rgba(122,162,255,.14);
      border-radius:18px;
      padding:14px;
      box-shadow:0 14px 40px rgba(0,0,0,.28);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }

    .quote{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
    }
    .quote b{ font-weight:900; }

    .stats{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    @media (min-width: 640px){ .stats{ grid-template-columns:1fr 1fr 1fr 1fr; } }
    .stat{
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.10);
    }
    .stat .k{ color:var(--muted); font-size:12px; }
    .stat .v{ font-size:18px; font-weight:900; margin-top:2px; }
    .progress{ width:100%; height:10px; background:rgba(255,255,255,.10); border-radius:999px; overflow:hidden; margin-top:8px; }
    .bar{ height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--ok)); transition:width .25s ease; }

    h2{ font-size:14px; margin:14px 0 8px; color:var(--muted); font-weight:900; letter-spacing:.2px; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.5; }
    .foot{ margin-top:10px; color:var(--muted); font-size:12px; line-height:1.55; }
    .hr{ height:1px; background:var(--line); margin:12px 0; }

    ul{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px; }
    li{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px;
      border-radius:16px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
    }
    input[type="checkbox"]{ transform:scale(1.25); margin-top:2px; }
    .task{ flex:1; }
    .task b{ display:block; font-weight:900; }
    .meta{ color:var(--muted); font-size:12px; margin-top:2px; }
    .tag{
      display:inline-block;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      margin-left:6px;
      background:rgba(0,0,0,.10);
    }

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(17,26,46,.98);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;
      border-radius:14px;
      box-shadow:0 14px 40px rgba(0,0,0,.35);
      max-width:min(560px, calc(100% - 20px));
      z-index:50;
    }
    .toast.hidden{ display:none; }
    .toast .row{ justify-content:flex-start; }
  </style>
</head>

<body>
<div class="wrap">

  <div class="appbar">
    <div class="brand">
      <div class="logo">
        <div style="font-size:22px">‚úùÔ∏è</div>
        <div>
          <h1 class="title">Christus Junior</h1>
          <div class="subtitle" id="dateLabel"></div>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <span class="badge" id="rangeLabel"></span>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="row" style="justify-content:flex-start">
        <span class="badge">üî• S√©rie : <b id="streak">0</b> jour(s)</span>
        <span class="badge">üìÖ Jour : <b id="dayIndex">‚Äî</b></span>
      </div>

      <div class="row" style="justify-content:flex-end">
        <button class="btn secondary" id="prevDay">‚Üê</button>
        <button class="btn secondary" id="today">Aujourd‚Äôhui</button>
        <button class="btn secondary" id="nextDay">‚Üí</button>
        <a class="btn" id="aelfLink" target="_blank" rel="noopener">üìñ √âvangile (AELF)</a>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="quote">
      <b>Mission du jour</b> üåü<br/>
      <div class="muted" style="margin-top:6px">
        Un petit pas chaque jour : pri√®re, sobri√©t√©, charit√©. L‚Äôimportant, c‚Äôest de revenir au Christ.
      </div>
      <div class="row" style="margin-top:10px; justify-content:flex-start; gap:10px">
        <button class="btn secondary" id="howInstall">üì≤ Ajouter √† l‚Äô√©cran d‚Äôaccueil</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="stats">
      <div class="stat">
        <div class="k">Aujourd‚Äôhui</div>
        <div class="v" id="dayPct">0%</div>
        <div class="progress"><div class="bar" id="dayBar"></div></div>
      </div>
      <div class="stat">
        <div class="k">Semaine</div>
        <div class="v" id="weekPct">0%</div>
        <div class="progress"><div class="bar" id="weekBar"></div></div>
      </div>
      <div class="stat">
        <div class="k">Car√™me</div>
        <div class="v" id="seasonPct">0%</div>
        <div class="progress"><div class="bar" id="seasonBar"></div></div>
      </div>
      <div class="stat">
        <div class="k">Bonus</div>
        <div class="v" id="bonusText">‚úÖ</div>
        <div class="muted" style="margin-top:2px; font-size:12px" id="bonusHint">Coche 1 truc, c‚Äôest d√©j√† bien.</div>
      </div>
    </div>
  </div>

  <div class="grid" style="margin-top:12px">
    <div class="card">
      <h2>‚úÖ √Ä faire aujourd‚Äôhui</h2>
      <ul id="todayTasks"></ul>
      <div class="foot" id="dayHint"></div>
      <div class="row" style="margin-top:12px; justify-content:flex-start; gap:10px">
        <button class="btn warn" id="resetDay">R√©initialiser le jour</button>
      </div>
    </div>

    <div class="card">
      <h2>üìå √Ä faire cette semaine</h2>
      <div class="muted" id="weekLabel" style="margin-bottom:10px"></div>
      <ul id="weekTasks"></ul>

      <div class="hr"></div>

      <h2>üéØ Avant P√¢ques</h2>
      <ul id="seasonTasks"></ul>

      <div class="row" style="margin-top:12px; justify-content:flex-start; gap:10px">
        <button class="btn warn" id="resetWeek">R√©initialiser la semaine</button>
        <button class="btn bad" id="resetAll">Tout r√©initialiser</button>
      </div>

      <div class="foot">‚ÄúSemaine‚Äù = lundi ‚Üí dimanche. Le bouton AELF ouvre la messe du jour.</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px; text-align:center">
    <h2>üó∫Ô∏è Parcours</h2>
    <img
      src="parcours-christus.png"
      alt="Parcours Christus"
      style="width:100%; max-width:560px; height:auto; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.10);"
    />
    <div class="foot">Astuce : ajoute cette page √† l‚Äô√©cran d‚Äôaccueil pour l‚Äôutiliser comme une appli.</div>
  </div>

</div>

<div class="toast hidden" id="toast">
  <div class="row" style="gap:10px">
    <div style="font-size:18px">üì≤</div>
    <div style="flex:1">
      <div style="font-weight:900">Ajouter √† l‚Äô√©cran d‚Äôaccueil</div>
      <div class="muted" id="installText" style="margin-top:2px; font-size:12px"></div>
    </div>
    <button class="btn secondary" id="closeToast">OK</button>
  </div>
</div>

<script>
(() => {
  // --- P√©riode Car√™me 2026
  const START = new Date("2026-02-18T00:00:00"); // Mercredi des Cendres
  const END   = new Date("2026-04-05T00:00:00"); // Dimanche de P√¢ques

  const KEY = "christus_junior_youth_v1";
  const $ = (id) => document.getElementById(id);

  // --- AELF URL
  function aelfUrl(iso){ return `https://www.aelf.org/${iso}/romain/messe`; }

  // --- Objectifs (version junior) ‚Äî sommeil 8h ‚úÖ
  const TASKS = {
    daily: [
      { id:"oraison", label:"Oraison : 15 minutes", cat:"Discipline spirituelle" },
      { id:"chapelet", label:"Chapelet : au moins une dizaine", cat:"Discipline spirituelle" },
      { id:"lecture", label:"Lecture : √âvangile ou liturgie du jour", cat:"Discipline spirituelle" },
      { id:"sobriete", label:"Sobri√©t√© num√©rique : pas apr√®s 21h", cat:"Asc√®se" },
      { id:"sommeil", label:"Sommeil : viser au moins 8h", cat:"Asc√®se" }
    ],
    weekdayOnly: [
      { id:"jeune_vendredi", label:"Je√ªne : vendredi", cat:"Asc√®se", days:[5] },
      { id:"abstinence_vendredi", label:"Abstinence : vendredi (viande)", cat:"Asc√®se", days:[5] },
    ],
    weekly: [
      { id:"aumone", label:"Aum√¥ne : 1 geste concret", cat:"Charit√© & fraternit√©" },
      { id:"fraternite", label:"Fraternit√© : partager 1 fois dans la semaine", cat:"Charit√© & fraternit√©" },
    ],
    season: [
      { id:"confession", label:"Confession : au moins 1 fois avant P√¢ques", cat:"Discipline spirituelle" },
    ]
  };

  // --- Helpers dates
  function clampToRange(d){
    const x = new Date(d); x.setHours(0,0,0,0);
    if(x < START) return new Date(START);
    if(x > END) return new Date(END);
    return x;
  }
  function toISODate(d){
    const x = new Date(d); x.setHours(0,0,0,0);
    const yyyy = x.getFullYear();
    const mm = String(x.getMonth()+1).padStart(2,'0');
    const dd = String(x.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function addDays(d, n){
    const x = new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x;
  }
  function dayOfWeek(d){ return new Date(d).getDay(); }
  function startOfWeekMonday(d){
    const x = new Date(d); x.setHours(0,0,0,0);
    const day = x.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    x.setDate(x.getDate()+diff);
    return x;
  }
  function formatFR(d){
    return new Intl.DateTimeFormat('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' }).format(d);
  }
  function formatShortFR(d){
    return new Intl.DateTimeFormat('fr-FR', { day:'2-digit', month:'2-digit' }).format(d);
  }
  function pct(done, total){ return total ? Math.round((done/total)*100) : 0; }
  function inRangeISO(iso){
    const d = new Date(iso+"T00:00:00");
    return d >= START && d <= END;
  }

  function dayIndexInSeason(d){
    // jour 1 = START
    const ms = (d - START);
    return Math.floor(ms/(1000*60*60*24)) + 1;
  }
  function totalDaysInSeason(){
    return Math.floor((END - START)/(1000*60*60*24)) + 1;
  }

  // --- Storage
  function load(){
    try { return JSON.parse(localStorage.getItem(KEY)) || {}; }
    catch { return {}; }
  }
  function save(s){ localStorage.setItem(KEY, JSON.stringify(s)); }

  // state:
  // days[iso] = { daily:{}, weekdayOnly:{} }
  // weeks[weekIsoMonday] = { weekly:{} }
  // season = { season:{} }
  // streak = { lastDoneIso:string, count:number }
  let state = load();
  if(!state.days) state.days = {};
  if(!state.weeks) state.weeks = {};
  if(!state.season) state.season = { season:{} };
  if(!state.streak) state.streak = { lastDoneIso:"", count:0 };

  function ensureDay(iso){
    if(!state.days[iso]) state.days[iso] = { daily:{}, weekdayOnly:{} };
    TASKS.daily.forEach(t => {
      if(typeof state.days[iso].daily[t.id] !== "boolean") state.days[iso].daily[t.id] = false;
    });
    TASKS.weekdayOnly.forEach(t => {
      if(typeof state.days[iso].weekdayOnly[t.id] !== "boolean") state.days[iso].weekdayOnly[t.id] = false;
    });
  }
  function ensureWeek(weekIso){
    if(!state.weeks[weekIso]) state.weeks[weekIso] = { weekly:{} };
    TASKS.weekly.forEach(t => {
      if(typeof state.weeks[weekIso].weekly[t.id] !== "boolean") state.weeks[weekIso].weekly[t.id] = false;
    });
  }
  function ensureSeason(){
    TASKS.season.forEach(t => {
      if(typeof state.season.season[t.id] !== "boolean") state.season.season[t.id] = false;
    });
  }

  function weekKey(dayDate){
    const ws = startOfWeekMonday(dayDate);
    return { ws, we: addDays(ws,6), key: toISODate(ws) };
  }

  let current = clampToRange(new Date());

  function updateHeader(){
    const iso = toISODate(current);
    $("dateLabel").textContent = formatFR(current);
    $("rangeLabel").textContent = `Car√™me 2026 ¬∑ ${formatShortFR(START)} ‚Üí ${formatShortFR(END)}`;
    $("aelfLink").href = aelfUrl(iso);

    $("prevDay").setAttribute("aria-disabled", current <= START ? "true" : "false");
    $("nextDay").setAttribute("aria-disabled", current >= END ? "true" : "false");

    $("dayIndex").textContent = `${dayIndexInSeason(current)}/${totalDaysInSeason()}`;
  }

  function tasksTodayFor(date){
    const out = [];
    TASKS.daily.forEach(t => out.push({ ...t, scope:"daily" }));
    const dow = dayOfWeek(date);
    TASKS.weekdayOnly.forEach(t => {
      if(t.days && t.days.includes(dow)){
        out.push({ ...t, scope:"weekdayOnly", extra: (dow===5 ? "Vendredi" : "Jour") });
      }
    });
    return out;
  }

  function anyTaskCheckedToday(){
    const iso = toISODate(current);
    ensureDay(iso);
    // check today's visible tasks
    const tasks = tasksTodayFor(current);
    return tasks.some(t => (t.scope==="daily" ? state.days[iso].daily[t.id] : state.days[iso].weekdayOnly[t.id]));
  }

  function updateStreak(){
    // streak increases when user checks at least 1 task on a date
    const iso = toISODate(current);
    const todayHas = anyTaskCheckedToday();
    const last = state.streak.lastDoneIso;

    if(!todayHas){
      // don't change streak
      return;
    }

    if(last === iso){
      // already counted
      return;
    }

    if(last){
      const lastDate = new Date(last + "T00:00:00");
      const diffDays = Math.round((new Date(iso+"T00:00:00") - lastDate)/(1000*60*60*24));
      if(diffDays === 1) state.streak.count = (state.streak.count || 0) + 1;
      else state.streak.count = 1;
    } else {
      state.streak.count = 1;
    }

    state.streak.lastDoneIso = iso;
    save(state);
  }

  function renderToday(){
    const iso = toISODate(current);
    ensureDay(iso);

    const list = $("todayTasks");
    list.innerHTML = "";

    const tasks = tasksTodayFor(current);
    tasks.forEach(t => {
      const li = document.createElement("li");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = (t.scope === "daily") ? state.days[iso].daily[t.id] : state.days[iso].weekdayOnly[t.id];

      cb.addEventListener("change", () => {
        if(t.scope === "daily") state.days[iso].daily[t.id] = cb.checked;
        else state.days[iso].weekdayOnly[t.id] = cb.checked;

        save(state);
        // streak: update if at least one checked
        updateStreak();
        renderAll(); // refresh stats + streak + progress
      });

      const div = document.createElement("div");
      div.className = "task";
      const b = document.createElement("b");
      b.textContent = t.label;
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = t.cat;

      if(t.extra){
        const span = document.createElement("span");
        span.className = "tag";
        span.textContent = t.extra;
        meta.appendChild(span);
      }

      div.appendChild(b);
      div.appendChild(meta);

      li.appendChild(cb);
      li.appendChild(div);
      list.appendChild(li);
    });

    const dow = dayOfWeek(current);
    let hint = "‚úÖ Mini objectif : coche au moins 1 truc aujourd‚Äôhui.";
    if(dow === 5) hint = "‚ú® Vendredi : je√ªne + abstinence. Courage !";
    if(dow === 0) hint = "üåø Dimanche : on respire, on remercie, on repart demain.";
    $("dayHint").innerHTML = hint;

    // bonus card text
    const checked = anyTaskCheckedToday();
    $("bonusText").textContent = checked ? "üî•" : "‚úÖ";
    $("bonusHint").textContent = checked ? "Bien jou√©. Garde le rythme." : "Coche 1 truc, c‚Äôest d√©j√† bien.";
  }

  function renderWeek(){
    const { ws, we, key } = weekKey(current);
    ensureWeek(key);

    $("weekLabel").textContent = `üìÖ ${formatShortFR(ws)} ‚Üí ${formatShortFR(we)}`;

    const list = $("weekTasks");
    list.innerHTML = "";

    TASKS.weekly.forEach(t => {
      const li = document.createElement("li");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = state.weeks[key].weekly[t.id];

      cb.addEventListener("change", () => {
        state.weeks[key].weekly[t.id] = cb.checked;
        save(state);
        renderAll();
      });

      const div = document.createElement("div");
      div.className = "task";
      const b = document.createElement("b");
      b.textContent = t.label;
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = t.cat;

      div.appendChild(b);
      div.appendChild(meta);

      li.appendChild(cb);
      li.appendChild(div);
      list.appendChild(li);
    });
  }

  function renderSeason(){
    ensureSeason();
    const list = $("seasonTasks");
    list.innerHTML = "";

    TASKS.season.forEach(t => {
      const li = document.createElement("li");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!state.season.season[t.id];

      cb.addEventListener("change", () => {
        state.season.season[t.id] = cb.checked;
        save(state);
        renderAll();
      });

      const div = document.createElement("div");
      div.className = "task";
      const b = document.createElement("b");
      b.textContent = t.label;
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = t.cat;

      div.appendChild(b);
      div.appendChild(meta);

      li.appendChild(cb);
      li.appendChild(div);
      list.appendChild(li);
    });
  }

  function todayProgress(){
    const iso = toISODate(current);
    ensureDay(iso);

    const tasks = tasksTodayFor(current);
    let done = 0;
    tasks.forEach(t => {
      const v = (t.scope === "daily") ? state.days[iso].daily[t.id] : state.days[iso].weekdayOnly[t.id];
      if(v) done++;
    });

    return { done, total: tasks.length, pct: pct(done, tasks.length) };
  }

  function weekProgress(){
    const { ws, key } = weekKey(current);
    ensureWeek(key);

    let total = 0, done = 0;

    for(let i=0;i<7;i++){
      const d = new Date(ws); d.setDate(ws.getDate()+i); d.setHours(0,0,0,0);
      const iso = toISODate(d);
      if(!inRangeISO(iso)) continue;

      ensureDay(iso);
      const tasks = tasksTodayFor(d);
      total += tasks.length;
      tasks.forEach(t => {
        const v = (t.scope === "daily") ? state.days[iso].daily[t.id] : state.days[iso].weekdayOnly[t.id];
        if(v) done++;
      });
    }

    total += TASKS.weekly.length;
    TASKS.weekly.forEach(t => { if(state.weeks[key].weekly[t.id]) done++; });

    return { done, total, pct: pct(done,total) };
  }

  function seasonProgress(){
    ensureSeason();

    let total = 0, done = 0;

    for(let d=new Date(START); d<=END; d=addDays(d,1)){
      const iso = toISODate(d);
      ensureDay(iso);

      const tasks = tasksTodayFor(d);
      total += tasks.length;
      tasks.forEach(t => {
        const v = (t.scope === "daily") ? state.days[iso].daily[t.id] : state.days[iso].weekdayOnly[t.id];
        if(v) done++;
      });
    }

    const seenWeeks = new Set();
    for(let d=new Date(START); d<=END; d=addDays(d,1)){
      const wk = weekKey(d).key;
      if(seenWeeks.has(wk)) continue;
      seenWeeks.add(wk);

      ensureWeek(wk);
      total += TASKS.weekly.length;
      TASKS.weekly.forEach(t => { if(state.weeks[wk].weekly[t.id]) done++; });
    }

    total += TASKS.season.length;
    TASKS.season.forEach(t => { if(state.season.season[t.id]) done++; });

    return { done, total, pct: pct(done,total) };
  }

  function updateProgress(){
    const dp = todayProgress();
    const wp = weekProgress();
    const sp = seasonProgress();

    $("dayPct").textContent = `${dp.pct}%`;
    $("weekPct").textContent = `${wp.pct}%`;
    $("seasonPct").textContent = `${sp.pct}%`;

    $("dayBar").style.width = `${dp.pct}%`;
    $("weekBar").style.width = `${wp.pct}%`;
    $("seasonBar").style.width = `${sp.pct}%`;
  }

  function updateStreakUI(){
    $("streak").textContent = String(state.streak?.count || 0);
  }

  // Navigation
  $("prevDay").addEventListener("click", () => {
    if(current <= START) return;
    current = addDays(current, -1);
    renderAll();
  });
  $("nextDay").addEventListener("click", () => {
    if(current >= END) return;
    current = addDays(current, 1);
    renderAll();
  });
  $("today").addEventListener("click", () => {
    current = clampToRange(new Date());
    renderAll();
  });

  // Reset
  $("resetDay").addEventListener("click", () => {
    const iso = toISODate(current);
    ensureDay(iso);

    const tasks = tasksTodayFor(current);
    tasks.forEach(t => {
      if(t.scope === "daily") state.days[iso].daily[t.id] = false;
      else state.days[iso].weekdayOnly[t.id] = false;
    });

    save(state);
    renderAll();
  });

  $("resetWeek").addEventListener("click", () => {
    const { key } = weekKey(current);
    ensureWeek(key);
    TASKS.weekly.forEach(t => state.weeks[key].weekly[t.id] = false);
    save(state);
    renderAll();
  });

  $("resetAll").addEventListener("click", () => {
    const ok = confirm(
      "√ätes-vous s√ªr de vouloir tout r√©initialiser ?\n\n" +
      "Cette action effacera toutes les coches enregistr√©es sur cet appareil."
    );
    if(!ok) return;

    localStorage.removeItem(KEY);
    state = { days:{}, weeks:{}, season:{ season:{} }, streak:{ lastDoneIso:"", count:0 } };
    save(state);
    renderAll();
  });

  // ‚ÄúAjouter √† l‚Äô√©cran d‚Äôaccueil‚Äù
  function showToast(text){
    $("installText").textContent = text;
    $("toast").classList.remove("hidden");
  }
  $("closeToast").addEventListener("click", () => $("toast").classList.add("hidden"));

  $("howInstall").addEventListener("click", () => {
    const ua = navigator.userAgent || "";
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    const isAndroid = /Android/i.test(ua);

    if(isIOS){
      showToast("Sur iPhone : ouvre dans Safari ‚Üí bouton Partager ‚Üí ‚ÄúSur l‚Äô√©cran d‚Äôaccueil‚Äù.");
    } else if(isAndroid){
      showToast("Sur Android : ouvre dans Chrome ‚Üí menu ‚ãÆ ‚Üí ‚ÄúAjouter √† l‚Äô√©cran d‚Äôaccueil‚Äù.");
    } else {
      showToast("Sur mobile : menu du navigateur ‚Üí ‚ÄúAjouter √† l‚Äô√©cran d‚Äôaccueil‚Äù (ou ‚ÄúInstaller l‚Äôappli‚Äù).");
    }
  });

  function renderAll(){
    updateHeader();
    renderToday();
    renderWeek();
    renderSeason();
    updateProgress();
    updateStreak();     // update streak if needed
    updateStreakUI();
  }

  // Init
  save(state);
  current = clampToRange(new Date());
  renderAll();
})();
</script>
</body>
</html>
